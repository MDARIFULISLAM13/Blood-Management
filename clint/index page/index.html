<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Blood Search</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f9f9f9;
        }

        header {
            background: #c0392b;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 22px;
        }

        nav button {
            margin-left: 10px;
            padding: 8px 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-login {
            background: #2980b9;
            color: #fff;
        }

        .btn-signup {
            background: #27ae60;
            color: #fff;
        }

        .btn-account {
            background: #f39c12;
            color: #fff;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        h2 {
            margin-bottom: 10px;
        }

        form {
            display: grid;
            gap: 10px;
        }

        select,
        input,
        button {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            width: 100%;
        }

        button.search-btn {
            background: #c0392b;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        button.search-btn:hover {
            background: #a93226;
        }

        .results {
            margin-top: 20px;
        }

        .card {
            background: #fafafa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .card p {
            margin: 5px 0;
        }

        .priority {
            font-weight: bold;
            color: #c0392b;
        }

        @media(max-width:600px) {
            header {
                flex-direction: column;
                text-align: center;
            }

            nav {
                margin-top: 10px;
            }
        }
    </style>
</head>

<body>

    <header>
        <h1>Blood Management</h1>
        <nav id="navBar"></nav>
    </header>

    <div class="container">
        <h2>Search Blood Donors</h2>
        <form id="bloodSearchForm">
            <select id="bloodGroup" required>
                <option value="">Select Blood Group</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
            </select>

            <select id="divisionSelect" required>
                <option value="">-- Select Division --</option>
            </select>

            <select id="districtSelect" disabled required>
                <option value="">-- Select District --</option>
            </select>

            <select id="upazilaSelect" disabled required>
                <option value="">-- Select Upazila --</option>
            </select>

            <label>When Needed:</label>
            <input type="date" id="neededDate" required>

            <button type="submit" class="search-btn">Search</button>
        </form>

        <div class="results" id="results"></div>
    </div>

    <script>
        const API = "http://localhost:4341/api";

        // ‚úÖ Navigation control
        function loadNav()
        {
            const nav = document.getElementById( "navBar" );
            const tokenMember = localStorage.getItem( "token_member" );
            const tokenMod = localStorage.getItem( "token_mod" );
            const tokenAdmin = localStorage.getItem( "token_admin" );

            if ( tokenMember || tokenMod || tokenAdmin )
            {
                nav.innerHTML = `<button class="btn-account" onclick="goAccount()">Account</button>`;
            } else
            {
                nav.innerHTML = `
            <button class="btn-login" onclick="goLogin()">Login</button>
            <button class="btn-signup" onclick="goSignup()">Sign Up</button>
        `;
            }
        }

        function goLogin()
        {
            window.location.href = "login.html";
        }

        function goSignup()
        {
            window.location.href = "signup.html";
        }

        function goAccount()
        {
            const tokenAdmin = localStorage.getItem( "token_admin" );
            const tokenMember = localStorage.getItem( "token_member" );
            const tokenMod = localStorage.getItem( "token_mod" );

            if ( tokenAdmin )
            {
                window.location.href = "../Accounts_Controller/Accounts/Admin/admin.html";   // Admin Page
            }
            else if ( tokenMod )
            {
                window.location.href = "../Accounts_Controller/Accounts/moderators/moderator.html";   // Moderator Page
            }
            else if ( tokenMember )
            {
                window.location.href = "../Accounts_Controller/Accounts/Members/member.html";   // Member Page
            }
        }


        // ‚úÖ Dynamic location dropdown
        let divisions = [];
        const divisionSelect = document.getElementById( 'divisionSelect' );
        const districtSelect = document.getElementById( 'districtSelect' );
        const upazilaSelect = document.getElementById( 'upazilaSelect' );

        async function loadLocationData()
        {
            try
            {
                const res = await fetch( `${API}/location_data` );
                divisions = await res.json();
                populateDivisions();
            } catch ( err )
            {
                alert( "Failed to load location data" );
            }
        }

        function populateDivisions()
        {
            clearSelect( divisionSelect );
            addOption( divisionSelect, "", "-- Select Division --" );
            divisions.forEach( div => addOption( divisionSelect, div.name, div.name ) );
            clearSelect( districtSelect ); addOption( districtSelect, "", "-- Select District --" );
            clearSelect( upazilaSelect ); addOption( upazilaSelect, "", "-- Select Upazila --" );
        }

        function populateDistricts( divisionName )
        {
            clearSelect( districtSelect );
            addOption( districtSelect, "", "-- Select District --" );
            const division = divisions.find( d => d.name === divisionName );
            if ( division )
            {
                division.districts.forEach( dist => addOption( districtSelect, dist.name, dist.name ) );
                districtSelect.disabled = false;
            } else districtSelect.disabled = true;

            clearSelect( upazilaSelect );
            addOption( upazilaSelect, "", "-- Select Upazila --" );
            upazilaSelect.disabled = true;
        }

        function populateUpazilas( divisionName, districtName )
        {
            clearSelect( upazilaSelect );
            addOption( upazilaSelect, "", "-- Select Upazila --" );
            const division = divisions.find( d => d.name === divisionName );
            if ( division )
            {
                const district = division.districts.find( dist => dist.name === districtName );
                if ( district )
                {
                    district.upazilas.forEach( upz => addOption( upazilaSelect, upz, upz ) );
                    upazilaSelect.disabled = false;
                }
            }
        }

        function clearSelect( selectElem ) { while ( selectElem.options.length > 0 ) selectElem.remove( 0 ); }
        function addOption( selectElem, value, text ) { const opt = document.createElement( "option" ); opt.value = value; opt.text = text; selectElem.appendChild( opt ); }

        divisionSelect.addEventListener( "change", e =>
        {
            if ( e.target.value ) populateDistricts( e.target.value );
        } );
        districtSelect.addEventListener( "change", e =>
        {
            if ( e.target.value ) populateUpazilas( divisionSelect.value, e.target.value );
        } );

        // ‚úÖ Blood search
        document.getElementById( "bloodSearchForm" ).addEventListener( "submit", async e =>
        {
            e.preventDefault();
            const blood_group = document.getElementById( "bloodGroup" ).value;
            const Division = divisionSelect.value;
            const District = districtSelect.value;
            const upazila = upazilaSelect.value;
            const neededDate = document.getElementById( "neededDate" ).value;

            const res = await fetch( `${API}/search_blood`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify( { blood_group, Division, District, upazila, neededDate } )
            } );

            const data = await res.json();
            const resultDiv = document.getElementById( "results" );
            resultDiv.innerHTML = "";

            if ( !Array.isArray( data ) || data.length === 0 )
            {
                resultDiv.innerHTML = "<p>No donors found.</p>";
                return;
            }

            data.forEach( d =>
            {
                const card = `
        <div class="card">
          <p><b>${d.name}</b> - ${d.mobile}</p>
          <p>üìç ${d.Division}, ${d.District}, ${d.upazila}</p>
          <p>ü©∏ Blood Group: ${d.blood_group}</p>
          <p>Last Donate: ${new Date( d.last_donate_date ).toLocaleDateString()}</p>
          <p class="priority">${d.priority}</p>
        </div>
      `;
                resultDiv.innerHTML += card;
            } );
        } );

        loadNav();
        loadLocationData();
    </script>

</body>

</html>