<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ROKTODAAN</title>
    <style>
        * {
            box-sizing: border-box;
            padding: 0;
            margin: 0;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(120deg, #e0f7fa, #fff);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .update-container {
            width: 100%;
            max-width: 500px;
            background: white;
            padding: 28px 22px;
            border-radius: 14px;
            box-shadow: 0 8px 24px rgba(44, 62, 80, 0.12);
        }

        .update-container h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #28a745;
            font-size: 1.4rem;
        }

        form label {
            font-size: 15px;
            color: #444;
            margin-top: 10px;
            display: block;
            margin-bottom: 3px;
        }

        form input,
        form select {
            width: 100%;
            padding: 12px 10px;
            margin-bottom: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 15px;
            background: #f8f8f8;
            transition: border 0.2s;
        }

        form input:focus,
        form select:focus {
            border-color: #28a745;
            outline: none;
            background: #eafaf1;
        }

        button[type="submit"] {
            width: 100%;
            padding: 14px;
            background-color: #28a745;
            color: white;
            font-size: 17px;
            margin-top: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.08);
            transition: background 0.2s;
        }

        button[type="submit"]:hover {
            background-color: #218838;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 22px;
            left: 50%;
            transform: translateX(-50%);
            min-width: 220px;
            background: #fff;
            color: #333;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12);
            padding: 14px 22px;
            font-size: 1rem;
            z-index: 9999;
            display: none;
            animation: fadeIn 0.4s;
        }

        .notification.success {
            border-left: 6px solid #28a745;
        }

        .notification.error {
            border-left: 6px solid #c0392b;
        }

        .notification.info {
            border-left: 6px solid #2196f3;
        }

        /* Spinner styles */
        #loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            z-index: 9998;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            border: 7px solid #f3f3f3;
            border-top: 7px solid #28a745;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 480px) {
            .update-container {
                padding: 12px 4px;
                border-radius: 10px;
            }

            form input,
            form select,
            button[type="submit"] {
                font-size: 14px;
                padding: 10px;
            }

            .update-container h2 {
                font-size: 1.1rem;
            }
        }
    </style>
</head>

<body>
    <div class="update-container">
        <form id="updateForm">
            <h2>Update My Details</h2>
            <label for="name">Full Name</label>
            <input type="text" id="name" name="name" required />
            <label for="divisionSelect">Division</label>
            <select id="divisionSelect" name="Division" required>
                <option value="">-- Select a Division --</option>
            </select>
            <label for="districtSelect">District</label>
            <select id="districtSelect" name="District" disabled required>
                <option value="">-- Select a District --</option>
            </select>
            <label for="upazilaSelect">Upazila</label>
            <select id="upazilaSelect" name="upazila" disabled required>
                <option value="">-- Select an Upazila --</option>
            </select>
            <label for="mobile">Mobile Number (11 digits)</label>
            <input type="text" id="mobile" name="mobile" required />
            <label for="blood">Blood Group</label>
            <select id="blood" name="blood_group" required>
                <option value="">Select Blood Group</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
            </select>
            <label for="last_donate_date">Last Donate Date</label>
            <input type="date" id="last_donate_date" name="last_donate_date" required />
            <button type="submit">Update Details</button>
        </form>
    </div>
    <div id="notification" class="notification"></div>
    <div id="loading-spinner">
        <div class="spinner"></div>
    </div>
    <script>
        const token = localStorage.getItem( "token_mod" );
        const member_url = "http://localhost:4341/api/moderator_details";
        const update_url = "http://localhost:4341/api/update_moderator";

        if ( !token )
        {
            showNotification( "Session Expired. Please log in again", "error" );
            setTimeout( () =>
            {
                window.location.href = "../../../log in/moderators/moderator.html";
            }, 1200 );
        }

        const divisionSelect = document.getElementById( 'divisionSelect' );
        const districtSelect = document.getElementById( 'districtSelect' );
        const upazilaSelect = document.getElementById( 'upazilaSelect' );
        let divisions = [];

        // Notification function
        function showNotification( message, type = "info", duration = 2500 )
        {
            const notif = document.getElementById( "notification" );
            notif.textContent = message;
            notif.className = `notification ${type}`;
            notif.style.display = "block";
            setTimeout( () => { notif.style.display = "none"; }, duration );
        }

        // Load Division/District/Upazila Data
        function loadLocationData()
        {
            fetch( 'http://localhost:4341/api/location_data' )
                .then( res => res.json() )
                .then( jsonData =>
                {
                    divisions = jsonData;
                    populateDivisions();
                } )
                .catch( err =>
                {
                    showNotification( "Failed to load location data", "error" );
                } );
        }

        function populateDivisions()
        {
            clearSelect( divisionSelect );
            addOption( divisionSelect, '', '-- Select a Division --' );
            divisions.forEach( div => addOption( divisionSelect, div.name, div.name ) );
        }

        function populateDistricts( divisionName )
        {
            clearSelect( districtSelect );
            addOption( districtSelect, '', '-- Select a District --' );
            const division = divisions.find( d => d.name === divisionName );
            if ( division )
            {
                division.districts.forEach( dist => addOption( districtSelect, dist.name, dist.name ) );
                districtSelect.disabled = false;
            }
            clearSelect( upazilaSelect );
            addOption( upazilaSelect, '', '-- Select an Upazila --' );
            upazilaSelect.disabled = true;
        }

        function populateUpazilas( divisionName, districtName )
        {
            clearSelect( upazilaSelect );
            addOption( upazilaSelect, '', '-- Select an Upazila --' );
            const division = divisions.find( d => d.name === divisionName );
            if ( division )
            {
                const district = division.districts.find( dist => dist.name === districtName );
                if ( district )
                {
                    district.upazilas.forEach( upz => addOption( upazilaSelect, upz, upz ) );
                    upazilaSelect.disabled = false;
                }
            }
        }

        function clearSelect( selectElem )
        {
            selectElem.innerHTML = "";
        }

        function addOption( selectElem, value, text )
        {
            const option = document.createElement( 'option' );
            option.value = value;
            option.text = text;
            selectElem.appendChild( option );
        }

        divisionSelect.addEventListener( 'change', e =>
        {
            populateDistricts( e.target.value );
        } );

        districtSelect.addEventListener( 'change', e =>
        {
            populateUpazilas( divisionSelect.value, e.target.value );
        } );

        // Autofill User Data
        function loadUserData()
        {
            document.getElementById( "loading-spinner" ).style.display = "flex";
            fetch( member_url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify( { token } )
            } )
                .then( res => res.json() )
                .then( data =>
                {
                    document.getElementById( "loading-spinner" ).style.display = "none";
                    if ( data.success )
                    {
                        const user = data.data;
                        document.getElementById( "name" ).value = user.name;
                        document.getElementById( "mobile" ).value = user.mobile;
                        document.getElementById( "blood" ).value = user.blood_group;
                        document.getElementById( "last_donate_date" ).value = user.last_donate_date ? user.last_donate_date.split( 'T' )[0] : "";
                        loadLocationData();
                        setTimeout( () =>
                        {
                            divisionSelect.value = user.Division;
                            populateDistricts( user.Division );
                            districtSelect.value = user.District;
                            populateUpazilas( user.Division, user.District );
                            upazilaSelect.value = user.upazila;
                        }, 500 );
                    } else
                    {
                        showNotification( "Failed to load user details!", "error" );
                    }
                } )
                .catch( () =>
                {
                    document.getElementById( "loading-spinner" ).style.display = "none";
                    showNotification( "Failed to load user details!", "error" );
                } );
        }

        // Submit Update
        document.getElementById( "updateForm" ).addEventListener( "submit", async function ( e )
        {
            e.preventDefault();
            const data = {};
            new FormData( this ).forEach( ( value, key ) => data[key] = value );
            document.getElementById( "loading-spinner" ).style.display = "flex";
            await new Promise( resolve => setTimeout( resolve, 10 ) );
            try
            {
                const response = await fetch( update_url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify( { token, updates: data } )
                } );
                const result = await response.json();
                if ( result.success )
                {
                    showNotification( "Details updated successfully!", "success" );
                    setTimeout( () =>
                    {
                        window.location.href = "../../Accounts/moderators/moderator.html";
                    }, 1200 );
                } else
                {
                    showNotification( result.message || "Update failed!", "error" );
                }
            } catch ( err )
            {
                showNotification( "Update failed!", "error" );
            }
            document.getElementById( "loading-spinner" ).style.display = "none";
        } );

        document.addEventListener( "DOMContentLoaded", () =>
        {
            loadUserData();
        } );
    </script>
    <div id="notification" class="notification"></div>
    <div id="loading-spinner">
        <div class="spinner"></div>
    </div>
</body>

</html>